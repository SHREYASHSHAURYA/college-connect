<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat â€¢ College Connect</title>


<style>
body {
  margin: 0;
  min-height: 100vh; 
  font-family: Arial, sans-serif;
  color: #e5e7eb;
  padding: 0 20px;

  background:
    radial-gradient(700px 350px at 20% 20%, rgba(34,197,94,0.25), transparent 60%),
    radial-gradient(600px 300px at 80% 75%, rgba(34,197,94,0.18), transparent 60%),
    repeating-linear-gradient(
      45deg,
      rgba(255,255,255,0.025) 0px,
      rgba(255,255,255,0.025) 1px,
      transparent 1px,
      transparent 6px
    ),
    linear-gradient(180deg, #020617, #000000);

  display: flex;
  align-items: center;
  justify-content: center;
}


#inbox {
  width: 240px;
  background: #020617;
  border: 1px solid rgba(34,197,94,0.25);
  border-radius: 12px;
  padding: 14px;
}


.inbox-user {
  padding: 10px;
  cursor: pointer;
  border-radius: 8px;
  margin-bottom: 6px;
  transition: background 0.2s ease;
}


.inbox-user:hover {
  background: rgba(34,197,94,0.12);
}


.badge {
  background: #22c55e;
  color: white;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 10px;
  float: right;
}

#chatArea {
  flex: 1;
  display: flex;
  flex-direction: column;
}


#chatBox {
  background: #020617;
  border: 1px solid rgba(34,197,94,0.25);
  border-radius: 12px;
  height: 360px; 
  overflow-y: auto;
  padding: 14px;
  margin-top: 10px;
}


.msg {
  max-width: 65%;
  margin: 8px 0;
  padding: 10px 14px;
  border-radius: 12px;
  clear: both;
  font-size: 14px;
}


.me {
  background: #22c55e;
  color: #000;
  float: right;
  text-align: right;
}


.me.seen {
  outline: 4px solid rgba(255,255,255,0.6);
}

.other {
  background: #111827;
  border: 1px solid rgba(34,197,94,0.25);
  float: left;
}

input {
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid rgba(34,197,94,0.4);
  background: #020617;
  color: #e5e7eb;
  outline: none;
}

input:focus {
  border-color: #22c55e;
  box-shadow: 0 0 0 2px rgba(34,197,94,0.25);
}

button {
  padding: 10px 16px;
  border-radius: 8px;
  border: 1px solid #22c55e;
  background: transparent;
  color: #22c55e;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
}

button:hover {
  background: rgba(34,197,94,0.12);
  transform: translateY(-1px);
}


.page {
  width: 100%;
  max-width: 1000px;
  background: #111827;
  border: 1px solid rgba(34,197,94,0.25);
  border-radius: 14px;
  padding: 28px;
  box-shadow:
    0 12px 30px rgba(0,0,0,0.55),
    inset 0 0 0 1px rgba(255,255,255,0.03);

  display: flex;
  gap: 20px;
}

#chatArea h2 {
color: #22c55e;
  text-align: center;
}
#chatArea {
  padding-top: 6px;
}

.chat-subheading {
  text-align: center;
  color: #9ca3af;
  font-size: 15px;
  margin-top: -6px;
  margin-bottom: 18px;
  line-height: 1.4;
}

@media (max-width: 640px) {
  .chat-subheading {
    font-size: 14px;
    margin-bottom: 14px;
  }
}

@media (max-width: 768px) {

  body {
    align-items: flex-start;
  }

  .page {
    flex-direction: column;
    padding: 16px;
  }

  #inbox {
    width: 100%;
    margin-bottom: 16px;
  }

  #chatArea {
    width: 100%;
 padding-top: 0;
  }

  #chatBox {
    height: 50vh;
  }

  input,
  button {
    width: 100%;
    margin-top: 8px;
  }

  .msg {
    max-width: 85%;
  }

  .msg img,
  .msg video {
    max-width: 100%;
    height: auto;
  }
}

#chatBox .msg img {
  width: auto !important;
  max-width: min(260px, 70vw) !important;
  max-height: min(260px, 70vw) !important;
  border-radius: 10px;
  object-fit: cover;
}

#chatBox .msg video {
  width: auto !important;
  max-width: min(300px, 75vw) !important;
  max-height: min(220px, 60vw) !important;
  border-radius: 10px;
}
/* ===== IMAGE / VIDEO PREVIEW MODAL ===== */
#imageModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;              /* hidden by default */
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#imageModalContent {
  max-width: 100%;
  max-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#imageModal img {
  max-width: 420px;
  max-height: 420px;
  width: auto;
  height: auto;
  border-radius: 12px;
  object-fit: contain;
}

#imageModal video {
  max-width: 520px;
  max-height: 300px;
  border-radius: 12px;
}

#closeModal {
  position: fixed;
  top: 16px;
  right: 20px;
  font-size: 32px;
  color: white;
  cursor: pointer;
  font-weight: bold;
  z-index: 10000;
  user-select: none;
}
/* ===== DESKTOP SPLIT-SCREEN FIX ===== */
.chat-start {
  display: flex;
  gap: 10px;
  align-items: center;
}

.chat-start input {
  flex: 1;
}

.chat-start button {
  width: auto;
  white-space: nowrap;
}


</style>
</head>

<body>
<div class="page">

<!-- INBOX -->
<div id="inbox">
  <b>Inbox</b>
  <div id="inboxList"></div>
</div>

<!-- CHAT -->
<div id="chatArea">
  <h2>Chat</h2>
<div class="chat-subheading">
  Private, real-time conversations with people you know
</div>


<div class="chat-start">
  <input id="withEmail" placeholder="Friend email">
  <button onclick="startChat()">Start Chat</button>
</div>


  <div id="chatBox"></div>

  <br>
  <input id="message" placeholder="Message">
<input type="file" id="mediaInput" accept="image/*,video/*">
<button onclick="sendMessage()">Send</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<div id="imageModal">
  <span id="closeModal">Ã—</span>
  <div id="imageModalContent"></div>
</div>
<script>
const token = localStorage.getItem("token");
const API = window.location.origin;

async function authFetch(url, options = {}) {
  const res = await fetch(url, {
    ...options,
    headers: {
      Authorization: "Bearer " + token,
      ...(options.headers || {})
    }
  });

  // ðŸš¨ AUTO LOGOUT ON BAN / INVALID TOKEN
  if (res.status === 401 || res.status === 403) {
    localStorage.clear();
    alert("Your account has been banned or logged out.");
    window.location.href = "login.html";
    throw new Error("Unauthorized");
  }

  return res;
}

function avatarHTML(user, size = 28) {
const img = user.profilePic
  ? `${API}/uploads/${user.profilePic}`
  : `${API}/uploads/default-avatar.png`;

  return `
    <span style="display:inline-flex;align-items:center;gap:6px;">
      <img src="${img}"
           style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover">
      <span>${user.name || user.email}</span>
    </span>
  `;
}

const socket = io(window.location.origin, {
  auth: { token }
});
if (!token) alert("No token");

const chatBox = document.getElementById("chatBox");
const inboxList = document.getElementById("inboxList");

let activeEmail = "";

/* ===================== INBOX ===================== */
async function loadInbox() {
  const res = await authFetch(`${API}/chat-inbox`);

  const data = await res.json();
  inboxList.innerHTML = "";

  data.forEach(c => {
    const div = document.createElement("div");
    div.className = "inbox-user";

    div.innerHTML = `
  <span onclick="event.stopPropagation(); openProfile('${c.email}')"
      style="cursor:pointer;">
    ${avatarHTML(c, 28)}
  </span>
${c.unread > 0 && c.email !== activeEmail && activeEmail !== c.email
  ? `<span class="badge">${c.unread}</span>`
  : ""}
`;

    div.onclick = () => {
      document.getElementById("withEmail").value = c.email;
      startChat();
    };

    inboxList.appendChild(div);
  });
}

/* ===================== CHAT ===================== */function addMessage(msg, isMe, seen = false, time = null) {
  const div = document.createElement("div");
  div.className = "msg " + (isMe ? "me" : "other");

  if (isMe && seen) {
    div.classList.add("seen");
  }

  if (msg.text) {
  div.appendChild(document.createTextNode(msg.text));
}

if (msg.media) {
  const url = `${API}/uploads/${msg.media.filename}`;

  if (msg.media.type === "image") {
    const img = document.createElement("img");
    img.src = url;
img.style.borderRadius = "8px";
img.style.display = "block";
    div.appendChild(img);
  }

  if (msg.media.type === "video") {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    div.appendChild(video);
  }
}

  if (time) {
    const t = document.createElement("div");
    t.style.fontSize = "10px";
    t.style.color = isMe ? "#ffffff" : "#22c55e";
    t.textContent = time;
    div.appendChild(document.createElement("br"));
    div.appendChild(t);
  }

  chatBox.appendChild(div);
}

socket.on("receive-message", (msg) => {

  if (!activeEmail) return;

const isCurrentChat =
  msg.sender.email === activeEmail ||
  msg.receiver.email === activeEmail;

if (!isCurrentChat) return;

// âœ… INSTANT READ ACK
if (msg.sender.email === activeEmail) {
  socket.emit("message-read", {
    fromEmail: msg.sender.email
  });
}


  const isMe = msg.sender.email !== activeEmail;

  addMessage(
    msg,
    isMe,
    false,
    new Date(msg.createdAt).toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit"
    })
  );

  requestAnimationFrame(() => {
    chatBox.scrollTop = chatBox.scrollHeight;
  });

});
socket.on("messages-seen", ({ by }) => {
  if (by !== activeEmail) return;

  // find all messages YOU sent
  const myMessages = document.querySelectorAll(".msg.me");
  if (!myMessages.length) return;

  // remove old seen state
  myMessages.forEach(m => m.classList.remove("seen"));

  // mark LAST sent message as seen
  myMessages[myMessages.length - 1].classList.add("seen");
loadInbox();
});


function formatDateLabel(dateStr) {
  const d = new Date(dateStr);
  const today = new Date();
  const yesterday = new Date();
  yesterday.setDate(today.getDate() - 1);

  const isSameDay = (a, b) =>
    a.getDate() === b.getDate() &&
    a.getMonth() === b.getMonth() &&
    a.getFullYear() === b.getFullYear();

  if (isSameDay(d, today)) return "Today";
  if (isSameDay(d, yesterday)) return "Yesterday";

  return d.toLocaleDateString(undefined, {
    day: "numeric",
    month: "short",
    year: "numeric"
  });
}


async function fetchChat() {
  if (!activeEmail) return;
  const res = await authFetch(
  `${API}/messages?withEmail=${activeEmail}`
);

  const msgs = await res.json();
 
  chatBox.innerHTML = "";
  // 1ï¸âƒ£ find last message YOU sent that is read
let lastSeenIndex = -1;

msgs.forEach((m, i) => {
  const isMe = m.sender.email !== activeEmail;
  if (isMe && m.readAt) {
    lastSeenIndex = i;
  }
});

// 2ï¸âƒ£ render messages
let lastDateLabel = "";

msgs.forEach((m, i) => {
  const isMe = m.sender.email !== activeEmail;
  const showSeen = isMe && i === lastSeenIndex;

const dateLabel = formatDateLabel(m.createdAt);


if (dateLabel !== lastDateLabel) {
  const sep = document.createElement("div");
  sep.textContent = dateLabel;

  sep.style.textAlign = "center";
  sep.style.margin = "16px 0";
  sep.style.fontSize = "12px";
  sep.style.color = "#9ca3af";
  sep.style.clear = "both"; // âœ… THIS FIXES IT

  chatBox.appendChild(sep);
  lastDateLabel = dateLabel;
}



addMessage(
  m,
  isMe,
  showSeen,
  new Date(m.createdAt).toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  })
);
});
loadInbox(); // refresh unread

// âœ… FORCE SCROLL AFTER FULL RENDER
requestAnimationFrame(() => {
  chatBox.scrollTop = chatBox.scrollHeight;
});
}

async function startChat() {
  const email = document.getElementById("withEmail").value;
  if (!email) return;

  activeEmail = email;

  // âœ… EXACTLY ONCE
  socket.emit("chat-opened", { withEmail: activeEmail });

  chatBox.innerHTML = "";
  fetchChat();
  socket.emit("message-read", { fromEmail: activeEmail });
}

async function sendMessage() {
  const text = document.getElementById("message").value;
  const file = document.getElementById("mediaInput").files[0];

  if (!activeEmail) return;
if (!text && !file) return;

  let media = null;

  if (file) {
    const formData = new FormData();
    formData.append("file", file);

    const res = await authFetch(`${API}/chat/upload`, {
  method: "POST",
  body: formData
});

    const data = await res.json();
    media = data; // { type, filename }
  }

  socket.emit("send-message", {
    toEmail: activeEmail,
    text,
    media
  });

  document.getElementById("message").value = "";
  document.getElementById("mediaInput").value = "";
}

/* ===================== REDIRECT FROM NOTIFICATION ===================== */
const params = new URLSearchParams(window.location.search);
const autoUser = params.get("user") || params.get("with");

if (autoUser) {
  document.getElementById("withEmail").value = autoUser;
  loadInbox().then(startChat);
  history.replaceState(null, "", "chat.html");
}
loadInbox();

// ===== POLLING: CHAT INBOX (NOT MESSAGES) =====
setInterval(() => {
  loadInbox();
}, 4000); // every 4 seconds

function openProfile(email) {
  window.location.href = `/profile.html?email=${encodeURIComponent(email)}`;
}
// ðŸ” IMAGE / VIDEO CLICK PREVIEW (CHAT)
document.addEventListener("click", e => {
  const modal = document.getElementById("imageModal");
  const container = document.getElementById("imageModalContent");

  if (e.target.tagName === "IMG" && e.target.closest(".msg")) {
    container.innerHTML = `<img src="${e.target.src}">`;
    modal.style.display = "flex";
  }

  if (e.target.tagName === "VIDEO" && e.target.closest(".msg")) {
    container.innerHTML = `<video src="${e.target.src}" controls autoplay></video>`;
    modal.style.display = "flex";
  }
});
// âŒ CLOSE PREVIEW
document.getElementById("closeModal").onclick = () => {
  document.getElementById("imageModal").style.display = "none";
  document.getElementById("imageModalContent").innerHTML = "";
};
// CLICK OUTSIDE CONTENT TO CLOSE
document.getElementById("imageModal").addEventListener("click", e => {
  if (e.target.id === "imageModal") {
    e.currentTarget.style.display = "none";
    document.getElementById("imageModalContent").innerHTML = "";
  }
});
window.addEventListener("beforeunload", () => {
  socket.emit("chat-closed");
});
</script>
</div>
</div>
</body>
</html>