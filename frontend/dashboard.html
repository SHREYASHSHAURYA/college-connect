<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Dashboard ‚Ä¢ College Connect</title>

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      color: #e5e7eb;

      background:
        radial-gradient(700px 350px at 20% 20%, rgba(34,197,94,0.25), transparent 60%),
        radial-gradient(600px 300px at 80% 75%, rgba(34,197,94,0.18), transparent 60%),
        repeating-linear-gradient(
          45deg,
          rgba(255,255,255,0.025) 0px,
          rgba(255,255,255,0.025) 1px,
          transparent 1px,
          transparent 6px
        ),
        linear-gradient(180deg, #020617, #000000);
    }

    .page {
      max-width: 840px;
      margin: auto;
      padding: 20px;
    }

    /* HEADER */
  .top {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  margin: 30px 0 50px;
}




 .brand {
  font-size: 38px;
  font-weight: 600;
  letter-spacing: 0.6px;
  white-space: nowrap;
  grid-column: 2;
  justify-self: center;
}




    .brand .accent {
      color: #22c55e;
    }

 .logout {
  background: transparent;
  border: 1px solid #22c55e;
  color: #22c55e;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  justify-self: end;
}



    .logout:hover {
      background: rgba(34,197,94,0.12);
    }

    /* STACKED CARDS */
    .stack {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      background: #111827;
      border: 1px solid rgba(34,197,94,0.25);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      box-shadow:
        0 8px 20px rgba(0,0,0,0.55),
        inset 0 0 0 1px rgba(255,255,255,0.03);
      transition: all 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: #22c55e;
      box-shadow: 0 12px 30px rgba(34,197,94,0.35);
    }

    .badge {
      background: #ef4444;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 6px;
    }
@media (max-width: 640px) {

  .page {
    padding: 16px;
  }

  .top {
  grid-template-columns: 1fr;
  row-gap: 14px;
  margin: 20px 0 30px;
}


  .brand {
    font-size: 28px;
  }

  .logout {
    width: 100%;
    text-align: center;
    padding: 12px;
justify-self: stretch;
  }

  .card {
    padding: 18px;
    font-size: 16px;
  }
}

  </style>
</head>

<body>

<div class="page">

  <div class="top">
  <div class="brand">
    <span class="accent">College</span> Connect
  </div>

  <button class="logout" onclick="logout()">Logout</button>
</div>

  <div class="stack">

    <div class="card" onclick="go('/chat')">
      Chat üí¨ <span id="chatCount"></span>
    </div>

    <div class="card" onclick="go('/friends')">
      Friends üë• <span id="friendsCount"></span>
    </div>

    <div class="card" onclick="go('/trips')">
      Trips üß≠ <span id="tripsCount"></span>
    </div>

    <div class="card" onclick="go('/marketplace')">
      Marketplace üõí
    </div>

    <div class="card" onclick="go('/forum')">
      Forum üó£Ô∏è
    </div>

    <div class="card" onclick="go('/notifications')">
      Notifications üîî <span id="notifCount"></span>
    </div>

    <div class="card" onclick="go('/profile')">
      Profile üë§
    </div>

    <div id="moderatorCard"
         class="card"
         style="display:none"
         onclick="go('/moderator')">
      Moderator üõ°Ô∏è <span id="reportCount"></span>
    </div>

  </div>
</div>

<script>
function go(page) {
  window.location.href = page;
}

function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("email");
  window.location.href = "/login";
}

if (!localStorage.getItem("token")) {
  window.location.href = "login.html";
}

const API = window.location.origin;
const token = localStorage.getItem("token");
const payload = JSON.parse(atob(token.split(".")[1]));
const role = localStorage.getItem("role");

function headers() {
  return { Authorization: "Bearer " + token };
}

if (payload.role === "moderator" || payload.role === "admin") {
  document.getElementById("moderatorCard").style.display = "block";
}

async function authFetch(url, options = {}) {
  const res = await fetch(url, {
    ...options,
    headers: {
      ...headers(),
      ...(options.headers || {})
    }
  });

  // üö® AUTO-LOGOUT BANNED USERS
  if (res.status === 403) {
    const data = await res.json();
    if (data.message === "Account banned") {
      localStorage.clear();
      alert("Your account has been banned.");
      window.location.href = "/login";
      throw new Error("Banned");
    }
  }

  // üîí TOKEN INVALID / EXPIRED
  if (res.status === 401) {
    localStorage.clear();
    window.location.href = "login.html";
    throw new Error("Unauthorized");
  }

  return res;
}

async function loadDashboardCounts() {
  document.getElementById("notifCount").innerHTML = "";
  document.getElementById("chatCount").innerHTML = "";
  document.getElementById("friendsCount").innerHTML = "";
  document.getElementById("tripsCount").innerHTML = "";

  const notifRes = await authFetch(`${API}/notifications`);
  const notifs = await notifRes.json();

  const unreadNotifs = notifs.filter(
  n =>
    !n.isRead &&
    n.type !== "chat" &&
    n.type !== "friend" &&
    n.type !== "verification"
).length;

  if (unreadNotifs > 0) {
    document.getElementById("notifCount").innerHTML =
      `<span class="badge">${unreadNotifs}</span>`;
  }

  const chatRes = await authFetch(`${API}/chat-unread-users`);
  const chatData = await chatRes.json();

  if (chatData.count > 0) {
    document.getElementById("chatCount").innerHTML =
      `<span class="badge">${chatData.count}</span>`;
  }

  const unreadFriends = notifs.filter(
    n => !n.isRead && n.type === "friend"
  ).length;

  if (unreadFriends > 0) {
    document.getElementById("friendsCount").innerHTML =
      `<span class="badge">${unreadFriends}</span>`;
  }

  if (role === "moderator" || role === "admin") {
    const repRes = await authFetch(`${API}/reports`);
    const reps = await repRes.json();

    const pending = reps.filter(r => r.status === "pending").length;
const verRes = await authFetch(`${API}/verification/pending/count`);
const pendingVerifications = (await verRes.json()).count;

const contactRes = await authFetch(`${API}/contact/pending`);
const pendingContacts = (await contactRes.json()).length;

   document.getElementById("reportCount").innerHTML =
  (pending + pendingVerifications + pendingContacts) > 0
    ? `<span class="badge">${pending + pendingVerifications + pendingContacts}</span>`
    : "";
  }
}

loadDashboardCounts();
setInterval(loadDashboardCounts, 5000);
</script>

</body>
</html>